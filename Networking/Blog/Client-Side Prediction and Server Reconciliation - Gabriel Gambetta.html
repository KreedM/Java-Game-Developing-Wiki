<!DOCTYPE html>
<!-- saved from url=(0081)https://www.gabrielgambetta.com/client-side-prediction-server-reconciliation.html -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  
  <meta name="generator" content="pandoc">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>Client-Side Prediction and Server Reconciliation - Gabriel Gambetta</title>
  <style type="text/css">code{white-space: pre;}</style>
  <link rel="stylesheet" href="./Client-Side Prediction and Server Reconciliation - Gabriel Gambetta_files/style.css">
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
  <script src="./Client-Side Prediction and Server Reconciliation - Gabriel Gambetta_files/all.js.download" async="" crossorigin="anonymous"></script><script id="twitter-wjs" src="./Client-Side Prediction and Server Reconciliation - Gabriel Gambetta_files/widgets.js.download"></script><script id="facebook-jssdk" src="./Client-Side Prediction and Server Reconciliation - Gabriel Gambetta_files/all.js(1).download"></script><script async="" src="./Client-Side Prediction and Server Reconciliation - Gabriel Gambetta_files/analytics.js.download"></script><script src="./Client-Side Prediction and Server Reconciliation - Gabriel Gambetta_files/jquery-3.2.1.min.js.download"></script>
  <!-- Google Analytics -->
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-17633478-1', 'auto');
    ga('send', 'pageview');
  
  
    var __send_ga_event = function(spec, opt_url) {
      var parts = spec.split("-");
      var opt_callback = undefined;
      if (!!opt_url) {
        //console.log("URL " + opt_url);
        opt_callback = {
          'transport': 'beacon',
          'hitCallback': function(){ document.location = opt_url; }
        };
      }
      //console.log("Event " + spec);
      ga('send', 'event', parts[0], parts[1], parts[2], opt_callback);
      return false;
    }
  
    var __add_gg_handlers = function(data_attr, opt_href_prefix) {
      $("[" + data_attr + "]").each(function(_, link) {
        var spec = $(link).attr(data_attr);
        var handler = (function() { 
          var href = undefined;
          if (!!opt_href_prefix) {        
            href = opt_href_prefix + spec;
            if (!$(link).attr("href")) {
              $(link).attr("href", href);
            }
          } else if (!$(link).attr("href")) {
            $(link).attr("href", "#");
          }
          var save_spec = spec;
          return function() { return __send_ga_event(save_spec, href); };
        })()
        $(link).click(handler);
      });
    }
  
    var __add_event_tracking = function() {
      __add_gg_handlers("gg-event");
      __add_gg_handlers("gg-link", "outbound.php?link=");
    }
  
    $(__add_event_tracking);
  </script>
  <!-- End Google Analytics -->
<script charset="utf-8" src="./Client-Side Prediction and Server Reconciliation - Gabriel Gambetta_files/button.e24f3bcdec527b80b9c80e88b62047c3.js.download"></script><style type="text/css" data-fbcssmodules="css:fb.css.basecss:fb.css.dialog css:fb.css.iframewidget">.fb_hidden{position:absolute;top:-10000px;z-index:10001}.fb_reposition{overflow:hidden;position:relative}.fb_invisible{display:none}.fb_reset{background:none;border:0;border-spacing:0;color:#000;cursor:auto;direction:ltr;font-family:"lucida grande", tahoma, verdana, arial, sans-serif;font-size:11px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;line-height:1;margin:0;overflow:visible;padding:0;text-align:left;text-decoration:none;text-indent:0;text-shadow:none;text-transform:none;visibility:visible;white-space:normal;word-spacing:normal}.fb_reset>div{overflow:hidden}@keyframes fb_transform{from{opacity:0;transform:scale(.95)}to{opacity:1;transform:scale(1)}}.fb_animate{animation:fb_transform .3s forwards}
.fb_dialog{background:rgba(82, 82, 82, .7);position:absolute;top:-10000px;z-index:10001}.fb_dialog_advanced{border-radius:8px;padding:10px}.fb_dialog_content{background:#fff;color:#373737}.fb_dialog_close_icon{background:url(https://static.xx.fbcdn.net/rsrc.php/v3/yq/r/IE9JII6Z1Ys.png) no-repeat scroll 0 0 transparent;cursor:pointer;display:block;height:15px;position:absolute;right:18px;top:17px;width:15px}.fb_dialog_mobile .fb_dialog_close_icon{left:5px;right:auto;top:5px}.fb_dialog_padding{background-color:transparent;position:absolute;width:1px;z-index:-1}.fb_dialog_close_icon:hover{background:url(https://static.xx.fbcdn.net/rsrc.php/v3/yq/r/IE9JII6Z1Ys.png) no-repeat scroll 0 -15px transparent}.fb_dialog_close_icon:active{background:url(https://static.xx.fbcdn.net/rsrc.php/v3/yq/r/IE9JII6Z1Ys.png) no-repeat scroll 0 -30px transparent}.fb_dialog_iframe{line-height:0}.fb_dialog_content .dialog_title{background:#6d84b4;border:1px solid #365899;color:#fff;font-size:14px;font-weight:bold;margin:0}.fb_dialog_content .dialog_title>span{background:url(https://static.xx.fbcdn.net/rsrc.php/v3/yd/r/Cou7n-nqK52.gif) no-repeat 5px 50%;float:left;padding:5px 0 7px 26px}body.fb_hidden{height:100%;left:0;margin:0;overflow:visible;position:absolute;top:-10000px;transform:none;width:100%}.fb_dialog.fb_dialog_mobile.loading{background:url(https://static.xx.fbcdn.net/rsrc.php/v3/ya/r/3rhSv5V8j3o.gif) white no-repeat 50% 50%;min-height:100%;min-width:100%;overflow:hidden;position:absolute;top:0;z-index:10001}.fb_dialog.fb_dialog_mobile.loading.centered{background:none;height:auto;min-height:initial;min-width:initial;width:auto}.fb_dialog.fb_dialog_mobile.loading.centered #fb_dialog_loader_spinner{width:100%}.fb_dialog.fb_dialog_mobile.loading.centered .fb_dialog_content{background:none}.loading.centered #fb_dialog_loader_close{clear:both;color:#fff;display:block;font-size:18px;padding-top:20px}#fb-root #fb_dialog_ipad_overlay{background:rgba(0, 0, 0, .4);bottom:0;left:0;min-height:100%;position:absolute;right:0;top:0;width:100%;z-index:10000}#fb-root #fb_dialog_ipad_overlay.hidden{display:none}.fb_dialog.fb_dialog_mobile.loading iframe{visibility:hidden}.fb_dialog_mobile .fb_dialog_iframe{position:sticky;top:0}.fb_dialog_content .dialog_header{background:linear-gradient(from(#738aba), to(#2c4987));border-bottom:1px solid;border-color:#043b87;box-shadow:white 0 1px 1px -1px inset;color:#fff;font:bold 14px Helvetica, sans-serif;text-overflow:ellipsis;text-shadow:rgba(0, 30, 84, .296875) 0 -1px 0;vertical-align:middle;white-space:nowrap}.fb_dialog_content .dialog_header table{height:43px;width:100%}.fb_dialog_content .dialog_header td.header_left{font-size:12px;padding-left:5px;vertical-align:middle;width:60px}.fb_dialog_content .dialog_header td.header_right{font-size:12px;padding-right:5px;vertical-align:middle;width:60px}.fb_dialog_content .touchable_button{background:linear-gradient(from(#4267B2), to(#2a4887));background-clip:padding-box;border:1px solid #29487d;border-radius:3px;display:inline-block;line-height:18px;margin-top:3px;max-width:85px;padding:4px 12px;position:relative}.fb_dialog_content .dialog_header .touchable_button input{background:none;border:none;color:#fff;font:bold 12px Helvetica, sans-serif;margin:2px -12px;padding:2px 6px 3px 6px;text-shadow:rgba(0, 30, 84, .296875) 0 -1px 0}.fb_dialog_content .dialog_header .header_center{color:#fff;font-size:16px;font-weight:bold;line-height:18px;text-align:center;vertical-align:middle}.fb_dialog_content .dialog_content{background:url(https://static.xx.fbcdn.net/rsrc.php/v3/y9/r/jKEcVPZFk-2.gif) no-repeat 50% 50%;border:1px solid #4a4a4a;border-bottom:0;border-top:0;height:150px}.fb_dialog_content .dialog_footer{background:#f5f6f7;border:1px solid #4a4a4a;border-top-color:#ccc;height:40px}#fb_dialog_loader_close{float:left}.fb_dialog.fb_dialog_mobile .fb_dialog_close_button{text-shadow:rgba(0, 30, 84, .296875) 0 -1px 0}.fb_dialog.fb_dialog_mobile .fb_dialog_close_icon{visibility:hidden}#fb_dialog_loader_spinner{animation:rotateSpinner 1.2s linear infinite;background-color:transparent;background-image:url(https://static.xx.fbcdn.net/rsrc.php/v3/yD/r/t-wz8gw1xG1.png);background-position:50% 50%;background-repeat:no-repeat;height:24px;width:24px}@keyframes rotateSpinner{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
.fb_iframe_widget{display:inline-block;position:relative}.fb_iframe_widget span{display:inline-block;position:relative;text-align:justify}.fb_iframe_widget iframe{position:absolute}.fb_iframe_widget_fluid_desktop,.fb_iframe_widget_fluid_desktop span,.fb_iframe_widget_fluid_desktop iframe{max-width:100%}.fb_iframe_widget_fluid_desktop iframe{min-width:220px;position:relative}.fb_iframe_widget_lift{z-index:1}.fb_iframe_widget_fluid{display:inline}.fb_iframe_widget_fluid span{width:100%}</style></head>
<body class="vsc-initialized">
<div class="main">
<div class="nav">
<a href="https://www.gabrielgambetta.com/client-server-game-architecture.html">&lt;&lt; Series Start</a>	<a class="homelink" href="https://www.gabrielgambetta.com/index.html">Gabriel Gambetta</a>
</div>
<header>
<h1 class="title">Fast-Paced Multiplayer (Part II): Client-Side Prediction and Server Reconciliation</h1>
</header>
<p><a href="https://www.gabrielgambetta.com/client-server-game-architecture.html">Client-Server Game Architecture</a> · <a href="https://www.gabrielgambetta.com/client-side-prediction-server-reconciliation.html">Client-Side Prediction and Server Reconciliation</a> · <a href="https://www.gabrielgambetta.com/entity-interpolation.html">Entity Interpolation</a> · <a href="https://www.gabrielgambetta.com/lag-compensation.html">Lag Compensation</a> · <a href="https://www.gabrielgambetta.com/client-side-prediction-live-demo.html">Live Demo</a></p>
<h2 id="introduction">Introduction</h2>
<p>In the&nbsp;<a href="https://www.gabrielgambetta.com/client-server-game-architecture.html">first article</a>&nbsp;of this series, we explored a client-server model with an authoritative server and dumb clients that just send inputs to the server and then render the updated game state when the server sends it.</p>
<p>A naive implementation of this scheme leads to a delay between user commands and changes on the screen; for example, the player presses the right arrow key, and the character takes half a second before it starts moving. This is because the client input must first travel to the server, the server must process the input and calculate a new game state, and the updated game state must reach the client again.</p>
<figure>
<img src="./Client-Side Prediction and Server Reconciliation - Gabriel Gambetta_files/fpm2-01.png" alt="Effect of network delays."><figcaption>Effect of network delays.</figcaption>
</figure>
<p>In a networked environment such as the internet, where delays can be in the orders of tenths of a second, a game may feel unresponsive at best, or in the worst case, be rendered unplayable. In this article, we’ll find ways to minimize or even eliminate that problem.</p>
<h2 id="client-side-prediction">Client-side prediction</h2>
<p>Even though there are some cheating players, most of the time the game server is processing valid requests (from non-cheating clients and from cheating clients who aren’t cheating at that particular time). This means most of the input received will be valid and will update the game state as expected; that is, if your character is at (10, 10) and the right arrow key is pressed, it will end up at (11, 10).</p>
<p>We can use this to our advantage. If the game world is&nbsp;<em>deterministic</em>&nbsp;enough (that is, given a game state and a set of inputs, the result is completely predictable),</p>
<p>Let’s suppose we have a 100 ms lag, and the animation of the character moving from one square to the next takes 100 ms. Using the naive implementation, the whole action would take 200 ms:</p>
<figure>
<img src="./Client-Side Prediction and Server Reconciliation - Gabriel Gambetta_files/fpm2-02.png" alt="Network delay + animation."><figcaption>Network delay + animation.</figcaption>
</figure>
<p>Since the world is deterministic, we can assume the inputs we send to the server will be executed successfully. Under this assumption, the client can predict the state of the game world after the inputs are processed, and most of the time this will be correct.</p>
<p>Instead of sending the inputs and waiting for the new game state to start rendering it, we can send the input and start rendering the outcome of that inputs as if they had succeded, while we wait for the server to send the “true” game state – which more often than not, will match the state calculated locally :</p>
<figure>
<img src="./Client-Side Prediction and Server Reconciliation - Gabriel Gambetta_files/fpm2-03.png" alt="Animation plays while the server confirms the action."><figcaption>Animation plays while the server confirms the action.</figcaption>
</figure>
<p>Now there’s absolutely no delay between the player’s actions and the results on the screen, while the server is still authoritative (if a hacked client would send invalid inputs, it could render whatever it wanted on the screen, but it wouldn’t affect the state of the server, which is what the other players see).</p>
<h2 id="synchronization-issues">Synchronization issues</h2>
<p>In the example above, I chose the numbers carefully to make everything work fine. However, consider a slightly modified scenario: let’s say we have a 250 ms lag to the server, and moving from a square to the next takes 100 ms. Let’s also say the player presses the right key 2 times in a row, trying to move 2 squares to the right.</p>
<p>Using the techniques so far, this is what would happen:</p>
<figure>
<img src="./Client-Side Prediction and Server Reconciliation - Gabriel Gambetta_files/fpm2-04.png" alt="Predicted state and authoritative state mismatch."><figcaption>Predicted state and authoritative state mismatch.</figcaption>
</figure>
<p>We run into an interesting problem at&nbsp;<strong>t = 250&nbsp;ms</strong>, when the new game state arrives. The predicted state at the client is&nbsp;<strong>x = 12</strong>, but the server says the new game state is&nbsp;<strong>x = 11</strong>. Because the server is authoritative, the client must move the character back to&nbsp;<strong>x = 11</strong>. But then, a new server state arrives at&nbsp;<strong>t = 350</strong>, which says&nbsp;<strong>x = 12</strong>, so the character jumps again, forward this time.</p>
<p>From the point of view of the player, he pressed the right arrow key twice; the character moved two squares to the right, stood there for 50 ms, jumped one square to the left, stood there for 100 ms, and jumped one square to the right. This, of course, is unacceptable.</p>
<h2 id="server-reconciliation">Server reconciliation</h2>
<p>The key to fix this problem is to realize that the client sees the game world <em>in present time</em>, but because of lag, the updates it gets from the server are actually the state of the game <em>in the past</em>. By the time the server sent the updated game state, it hadn’t processed all the commands sent by the client.</p>
<p>This isn’t terribly difficult to work around, though. First, the client adds a sequence number to each request; in our example, the first key press is request #1, and the second key press is request #2. Then, when the server replies, it includes the sequence number of the last input it processed:</p>
<figure>
<img src="./Client-Side Prediction and Server Reconciliation - Gabriel Gambetta_files/fpm2-05.png" alt="Client-side prediction + server reconciliation."><figcaption>Client-side prediction + server reconciliation.</figcaption>
</figure>
<p>Now, at&nbsp;<strong>t = 250</strong>, the server says “<strong>based on what I’ve seen up to your request #1, your position is x = 11</strong>”. Because the server is authoritative, it sets the character position at&nbsp;<strong>x = 11</strong>. Now let’s assume the client keeps a copy of the requests it sends to the server. Based on the new game state, it knows the server has already processed request #1, so it can discard that copy. But it also knows the server still has to send back the result of processing request #2. So applying client-side prediction again, the client can calculate the “present” state of the game based on the last authoritative state sent by the server, plus the inputs the server hasn’t processed yet.</p>
<p>So, at&nbsp;<strong>t = 250</strong>, the client gets “<strong>x = 11, last processed request = #1</strong>”. It discards its copies of sent input up to #1 – but it retains a copy of #2, which hasn’t been acknowledged by the server. It updates its internal game state with what the server sent,&nbsp;<strong>x = 11</strong>, and then applies all the input still not seen by the server – in this case, input #2, “move to the right”. The end result is&nbsp;<strong>x = 12</strong>, which is correct.</p>
<p>Continuing with our example, at&nbsp;<strong>t = 350</strong>&nbsp;a new game state arrives from the server; this time it says “<strong>x = 12, last processed request = #2</strong>”. At this point, the client discards all input up to #2, and updates the state with&nbsp;<strong>x = 12</strong>. There’s no unprocessed input to replay, so processing ends there, with the correct result.</p>
<h2 id="odds-and-ends">Odds and ends</h2>
<p>The example discussed above implies movement, but the same principle can be applied to almost anything else. For example, in a turn-based combat game, when the player attacks another character, you can show blood and a number representing the damage done, but you shouldn’t actually update the health of the character until the server says so.</p>
<p>Because of the complexities of game state, which isn’t always easily reversible, you may want to avoid killing a character until the server says so, even if its health dropped below zero in the client’s game state (what if the other character used a first-aid kit just before receiving your deadly attack, but the server hasn’t told you yet?)</p>
<p>This brings us to an interesting point – even if the world is completely deterministic and no clients cheat at all, it’s still possible that the state predicted by the client and the state sent by the server don’t match after a reconciliation. The scenario is impossible as described above with a single player, but it’s easy to run into when several players are connected to the server at once. This will be the topic of the next article.</p>
<h3 id="summary">Summary</h3>
<p>When using an authoritative server, you need to give the player the illusion of responsiveness, while you wait for the server to actually process your inputs. To do this, the client simulates the results of the inputs. When the updated server state arrives, the predicted client state is recomputed from the updated state and the inputs the client sent but the server hasn’t acknowledged yet.</p>
<div class="centered">
<a href="https://www.gabrielgambetta.com/client-server-game-architecture.html">&lt;&lt; Part I: Client-Server Game Architecture</a> · <a href="https://www.gabrielgambetta.com/entity-interpolation.html"><strong>Part III: Entity Interpolation &gt;&gt;</strong></a>
</div>
<div id="signup" class="signup signup_tgl">  <form id="signup_form" action="https://www.gabrielgambetta.com/signup.php" method="GET">
    <b>Stay in touch!</b> Your email:    <input type="email" id="signup_email" name="email">
    <input type="submit" id="signup_submit" value="Keep me posted">
    <input type="hidden" name="a" value="s">
    <input type="hidden" name="m" value="gamedev">
    <input type="hidden" name="r" value="fpm2">
    <input type="hidden" name="l" value="">
  </form>

  <div id="signup_error" style="display: none; font-size: 75%; color: red; font-weight: bold;">Please enter a valid email address.</div>

  <script>
    $("#signup_submit").click(function() {
      var email = $("#signup_email").val();
      var re = /\S+@\S+\.\S+/; 
      if (re.test(email)) {
        $("#signup_error").css("display", "none");
        $("#signup_submit").prop("disabled", true);
        $("#signup").load("/signup.php?" + $("#signup_form").serialize());
      } else {
        $("#signup_error").css("display", "block");
        $("#signup_submit").prop("disabled", false);
      }
      return false;
    });
  </script>
</div>
<script>$("#signup").load("/signup.php?m=gamedev&r=fpm2");</script>
<hr>
<div class="social">

<!-- Facebook -->
<div id="fb-root" class=" fb_reset"><div style="position: absolute; top: -10000px; width: 0px; height: 0px;"><div></div></div></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>

<div class="fb-like fb_iframe_widget" data-send="false" data-layout="button_count" data-width="450" data-show-faces="false" style="width: 150px;" fb-xfbml-state="rendered" fb-iframe-plugin-query="app_id=&amp;container_width=150&amp;href=https%3A%2F%2Fwww.gabrielgambetta.com%2Fclient-side-prediction-server-reconciliation.html&amp;layout=button_count&amp;locale=en_US&amp;sdk=joey&amp;send=false&amp;show_faces=false&amp;width=450"><span style="vertical-align: bottom; width: 75px; height: 20px;"><iframe name="f285161bddaf21" width="450px" height="1000px" data-testid="fb:like Facebook Social Plugin" title="fb:like Facebook Social Plugin" frameborder="0" allowtransparency="true" allowfullscreen="true" scrolling="no" allow="encrypted-media" src="./Client-Side Prediction and Server Reconciliation - Gabriel Gambetta_files/like.html" style="border: none; visibility: visible; width: 75px; height: 20px;" class=""></iframe></span></div>

<!-- Twitter -->
<iframe id="twitter-widget-0" scrolling="no" frameborder="0" allowtransparency="true" allowfullscreen="true" class="twitter-share-button twitter-share-button-rendered twitter-tweet-button" style="position: static; visibility: visible; width: 60px; height: 20px;" title="Twitter Tweet Button" src="./Client-Side Prediction and Server Reconciliation - Gabriel Gambetta_files/tweet_button.2d7d9a6d04538bf11c7b23641e75738c.en.html"></iframe>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

</div>
</div>
<div class="copyright">© Gabriel Gambetta 2019</div>


<iframe scrolling="no" frameborder="0" allowtransparency="true" src="./Client-Side Prediction and Server Reconciliation - Gabriel Gambetta_files/widget_iframe.2d7d9a6d04538bf11c7b23641e75738c.html" title="Twitter settings iframe" style="display: none;"></iframe></body></html>